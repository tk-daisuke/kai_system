---
trigger: always_on
---

# Co-worker Bot 開発指示書

## 1. プロジェクト概要
社内の定型業務（CSVデータのダウンロードとExcelへの転記）を自動化するPythonツール「Co-worker Bot」を作成する。
本ツールは「共同作業者」として振る舞い、ユーザーのシフト（8時、13時、22時など）に応じて必要なタスクを一括実行する。

## 2. システム構成・環境
* **言語:** Python 3.10+
* **配布形態:** PyInstaller等でExe化し、各クライアントPCに配布（Python環境がないPCでも動作すること）。
* **OS:** Windows 10/11
* **必須ライブラリ:**
    * `win32com.client` (Excel操作、必須)
    * `tkinter` (GUI選択画面、標準ライブラリ)
    * `pandas` (設定ファイル読込用)
    * `openpyxl` (設定ファイル読込用エンジン)
* **ネットワーク環境:**
    * 設定マスタファイル（Excel）は社内ネットワーク上の共有フォルダに配置される。
    * 操作対象の業務Excelファイルは、ローカル、共有フォルダ問わずフルパスで指定される。

## 3. ユーザー体験（UX）フロー
1.  **起動:** ユーザーが `Co-worker_Bot.exe` を実行。
2.  **グループ選択 (対話型UI):**
    * 小さなウィンドウが立ち上がり、「どの業務を実行しますか？」と尋ねる。
    * マスタファイルから読み取ったグループ名（例: `08:00業務`, `13:00業務`）がボタンとして表示される。
3.  **実行:** ボタンを押すと、そのグループに紐づくタスクが順次実行される。
4.  **共同作業（一時停止）:**
    * 設定により、処理の途中で「メール送信してください」等のポップアップを表示し、処理を一時停止する。
    * ユーザーが作業後に「OK」を押すと、処理を再開（保存・終了）する。
5.  **完了:** 全タスク終了後、完了メッセージを表示して終了する。

## 4. 設定マスタファイル仕様
* **ファイル名:** `Task_Master.xlsx`
* **配置場所:** 共有ネットワークパス（コード内の定数で設定、または同階層読み込み）
* **シート名:** `TaskList`
* **カラム構成:**

| 列 | 項目名 | 説明 |
|:---|:---|:---|
| A | Group | グループ名（ボタンのラベルになる。例: `08:00業務`） |
| B | StartTime | 開始可能時刻（例: `07:50`）。これより前の実行はスキップ。 |
| C | FilePath | 対象Excelファイルのフルパス（`\\Server\Share\売上.xlsm` 等） |
| D | TargetSheet | 転記先のシート名 |
| E | SearchKey | ダウンロードされるCSVに含まれるキーワード |
| F | DownloadURL | ダウンロードURL |
| G | ActionAfter | 完了後の動作。`Save`（自動保存して閉じる） または `Pause`（一時停止して手動作業を促す） |
| H | Active | `TRUE`なら有効、`FALSE`なら無効 |

## 5. 機能要件詳細

### 5.1 初期化・GUI生成
* `Task_Master.xlsx` を読み込み、`Active=TRUE` のユニークな `Group` リストを作成する。
* `tkinter` を使用して、グループ選択ボタンを動的に生成する。
* マスタファイル読み込み時は、他ユーザーが編集中でも読めるよう、排他制御に注意する（Read Onlyで開く、またはpandasで一時コピーを読むなど）。

### 5.2 実行ロジック（逐次処理）
選択されたグループに該当する行について、上から順に以下を実行する。

1.  **時刻チェック:** 現在時刻が `StartTime` 未満なら「まだ時間外です」とログに出してスキップ。
2.  **Excel起動:** `win32com` を使用して対象ブックを開く。
    * **重要:** ブックを開くことで、セル内の動的URL（関数）を再計算させること。
3.  **前処理:**
    * `Downloads` フォルダ（`os.environ["USERPROFILE"]`使用）内に、`SearchKey` を含むCSVがあれば削除する（誤爆防止）。
4.  **ダウンロード:**
    * 標準ブラウザ (`webbrowser` モジュール) でURLを開く。
    * 認証はブラウザの既存セッションを利用する。
5.  **待機・検知:**
    * `Downloads` フォルダを監視。
    * 拡張子が厳密に `.csv` であるファイルが生成され、かつファイルロックが解除されるのを待つ（タイムアウト60秒）。
6.  **データ取込:**
    * ダウンロードしたCSVを `win32com` でExcelとして開く（文字化け回避のため）。
    * 全データをコピーし、対象ブックの `TargetSheet` のA1セルへ貼り付ける。
    * 使用したCSVは即座に閉じて削除する。
7.  **完了後アクション (ActionAfter):**
    * `Pause`: Excelを表示状態にし、最前面にポップアップメッセージ（`ctypes.windll.user32.MessageBoxW` 推奨）を表示。「手動作業を行ってください」と促す。OK押下で次へ。
    * `Save`: 上書き保存する。
8.  **終了処理:** ブックを閉じる。

### 5.3 エラーハンドリング
* **ブックが見つからない:** ログに出力して次のタスクへ進む（止まらない）。
* **タイムアウト:** ダウンロードされなかった場合、ログに出力して次のタスクへ進む。
* **ログ:** 実行結果（成功/失敗/スキップ）を `log_YYYYMMDD.txt` に出力する。

## 6. ディレクトリ構成案

```text
Project_Root/
│
├── src/
│   ├── main.py           # エントリーポイント (GUI制御)
│   ├── logic_robot.py    # ロボットロジック (Excel/Web操作)
│   ├── config_loader.py  # マスタ読み込み
│   └── utils.py          # ログ、共通関数
│
├── settings/
│   └── Task_Master.xlsx  # 設定マスタ（開発用サンプル）
│
└── requirements.txt      # 依存ライブラリ